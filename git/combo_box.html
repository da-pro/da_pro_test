<!doctype html>
<html>
<head>
<title>Combo Box</title>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>
<style>
html, body, header, footer, section, article, nav, div, img, form, input, textarea, select, optgroup, option, label, table, thead, tbody, tfoot, tr, th, td, dl, dt, dd, ol, ul, li, pre, p, h1, h2, h3, h4, h5, h6, span, br, hr, a {margin:0; padding:0; border:0; vertical-align:baseline;}
table {width:50%; text-align:center; border-collapse:separate; border-spacing:1px; cursor:default;}
ol, ul {list-style:none;}
h1, h2, h3, h4, h5, h6 {font-size:100%;}
a {text-decoration:none; outline:none;}
/* CUSTOM */
body {margin-top:200px;}
form {width:320px; margin:20px auto 0;}
input {width:100%; height:30px; margin:0 0 20px; padding:0 35px 0 5px; color:#333333; background:#bbeeff; font:14px 'Open Sans', sans-serif; border:1px solid #66ddff; border-radius:3px; box-sizing:border-box; display:block;}
input:focus {background:#ffffff; outline:none;}
input:hover { cursor:pointer;}
input:focus:hover {cursor:auto;}
div.combo-box {position:relative;}
div.combo-box>span {width:30px; height:30px; position:absolute; right:0; background:#bbeeff; border-radius:0 3px 3px 0; border:1px solid #66ddff;box-sizing:border-box;}
div.combo-box>span:hover {cursor:pointer;}
div.combo-box>span>i {border-style:solid; border-color:#242424; border-width:0 2px 2px 0; display:inline-block; padding:3px; position:absolute; top:9px; right:10px; transform: rotate(45deg); -webkit-transform: rotate(45deg);}
input + ul {width:100%; height:auto; max-height:290px; padding:0; background:#cccccc; position:absolute; border-radius:3px; overflow-x:hidden; overflow-y:auto; display:grid; grid-template-columns:100%; row-gap:1px; border:1px solid #cccccc;box-sizing:border-box; z-index:1000;}
input + ul.down {top:30px;}
input + ul.up {bottom:30px;}
ul > li {width:100%; padding:0 0 0 4px; color:#242424; background:#f0f0f0; font:14px/25px arial, sans-serif; white-space:nowrap; box-sizing:border-box;}
ul.combo-box > li.custom {background:#00ffff; cursor:not-allowed;}
ul.combo-box > li>b {font-weight:bold;}
ul.combo-box > li.header {height:28px; position:sticky; top:0; background:#ffffff; font-size:11px; line-height:28px; font-weight:bold; cursor:default;}
ul.combo-box > li.warning {padding:0; color:#ff3333; font-size:12px; font-weight:bold; text-align:center;}
ul.combo-box > li.highlight {background:#fafafa; }
ul.combo-box>li.optgroup {padding:0 0 0 14px; color:#ffffff; background:#666666; font-weight:bold; cursor:default;}
ul.combo-box>li:not(.header):not(.optgroup):hover, ul.combo-box>li.active {background:#cccccc; cursor:pointer;}
</style>
<script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
<form>
	<div class="combo-box" style="position:relative; width:100%;">
		<span title="Покажи Автомобили"><i></i></span>
		<input type="text" spellcheck="false" id="js-combo-box-cars">
		
	<ul class="combo-box"  style="display:none">
		<li class="header warning">няма резултат</li>
		<li class="header">намерени 14</li>
		<li>test</li>
		<li>t<b>es</b>t</li>
		<li>test</li>
		<li>test</li>
		<li>test</li>
		<li class="optgroup">TEST</li>
		<li>test</li>
		<li>test</li>
		<li>test</li>
		<li>test</li>
		<li>test</li>
		<li>test</li>
		<li>test</li>
		<li>test</li>
		<li>test</li>
	</ul>
		
	</div>
	<select id="js-combo-box-cars" style="display:none">
		<option value="">избери</option>
		<optgroup label="German">
			<option value="100">TestovaTestovaTestovaTestova</option>
			<option value="1">Audi</option>
			<option value="2">BMW XT series</option>
			<option value="7">BMW bGT</option>
			<option value="8">BMW 8</option>
			<option value="9">BMW GT 9</option>
			<option value="3">Mercedes</option>
			<option value="5">Opel</option>
			<option value="6">Volkswagen</option>
		</optgroup>
		<optgroup label="Italian">
		<option value="4">Fiat</option>
		</optgroup>
		<optgroup label="French">
		<option value="11">Citroen</option>
		<option value="12">Peugeot</option>
		<option value="13">Renault</option>
		</optgroup>
	</select>
	<div class="combo-box" style="position:relative; width:100%;">
		<span title="Покажи Езици"><i></i></span>
	<input type="text" id="js-combo-box-languages">
	</div>
		<select id="js-combo-box-languages" style="display:none">
		<option value="3">JavaScript</option>
		<option value="2">PHP</option>
		<option value="4">Ruby</option>
		<option value="1">Action Script</option>
		<option value="6">CSS</option>
		<option value="5">HTML</option>
		<option value="7">Java</option>
		<option value="8">C#</option>
		<option value="9">Python</option>
		<option value="10">Basic</option>
		<option value="11">SQL</option>
		<option value="12">MySQL</option>
	</select>
		<div class="combo-box" style="position:relative; width:100%;">
	<input type="text" id="js-combo-box-cities">
	</div>
	<input type="text" id="js-combo-box-names">
</form>
<script>
var combo_box = {
	selector_scheme : 'js-combo-box',
	is_data_ready : false,
	data : {},
	input_fields : [],
	input_characters : '',
	focused_input : '',
	custom_config : {},
	config : {
		is_value_numeric : false,
		are_mathematics_symbols_allowed : false,
		are_punctuation_symbols_allowed : false,
		minimum_input_length : 1,
		found_message : 'намерени %',
		matched_message : 'съвпадения %',
		search_message : '\u043d\u0430\u043f\u0438\u0448\u0435\u0442\u0435 \u043c\u0438\u043d\u0438\u043c\u0443\u043c % \u0441\u0438\u043c\u0432\u043e\u043b\u0430',
		empty_result : '\u043d\u044f\u043c\u0430 \u0440\u0435\u0437\u0443\u043b\u0442\u0430\u0442',
		active_drop_down_list : '',
		active_list_item : 'active',
		json : null
	},
	strings : {
		///////
	},
	test : [],
	/*
	config : {
		initial : {
			is_value_numeric : false,
			are_mathematics_symbols_allowed : false,
			are_punctuation_symbols_allowed : false,
			minimum_input_length : 3,
			search_message : '\u043d\u0430\u043f\u0438\u0448\u0435\u0442\u0435 \u043c\u0438\u043d\u0438\u043c\u0443\u043c % \u0441\u0438\u043c\u0432\u043e\u043b\u0430',
			empty_result : '\u043d\u044f\u043c\u0430 \u0440\u0435\u0437\u0443\u043b\u0442\u0430\u0442',
			active_drop_down_list : '',
			active_list_item : 'active',
			json : null
		},
		inherit : {},
	},
	press_event : {
		up : false,
		down : false,
		enter : false
	}
	*/
	events : {
		press_up_arrow : false,
		press_down_arrow : false,
		press_enter : false
	},
	drop_down : {
		selector : '',
		length : 0,
		pointer : 0
	},
	init : function()
	{
		this.construct();
	},
	construct : function(object)
	{
		if (Object.keys(object).length)
		{
			//console.log(Object.keys(object));
		}
		if (!$.isEmptyObject(object))
		{
			let css_class_name_pattern = new RegExp('^[a-z_]{1}[a-z0-9-_]+$', 'i');

			for (let i in object)
			{
				if (object.hasOwnProperty(i))
				{
					if (i.indexOf(this.selector_scheme) !== 0)
					{
						continue;
					}
					
					this.data[i] = {};
					this.custom_config[i] = {
							is_select : false
						};
					
					this.input_fields.push(i);
					/* remove obsolete
					if (object[i].hasOwnProperty('is_value_numeric'))
					{
						if (typeof object[i].is_value_numeric === 'boolean')
						{
							this.custom_config[i].is_value_numeric = object[i].is_value_numeric;
						}
					}
					*/
					if (object[i].hasOwnProperty('are_mathematics_symbols_allowed'))
					{
						if (typeof object[i].are_mathematics_symbols_allowed === 'boolean')
						{
							this.custom_config[i].are_mathematics_symbols_allowed = object[i].are_mathematics_symbols_allowed;
						}
					}
					
					if (object[i].hasOwnProperty('are_punctuation_symbols_allowed'))
					{
						if (typeof object[i].are_punctuation_symbols_allowed === 'boolean')
						{
							this.custom_config[i].are_punctuation_symbols_allowed = object[i].are_punctuation_symbols_allowed;
						}
					}
					
					if (object[i].hasOwnProperty('minimum_input_length'))
					{
						if (typeof object[i].minimum_input_length === 'number')
						{
							if (object[i].minimum_input_length > 0)
							{
								this.custom_config[i].minimum_input_length = object[i].minimum_input_length;
							}
						}
					}
					
					if (object[i].hasOwnProperty('active_drop_down_list'))
					{
						if (typeof object[i].active_drop_down_list === 'string')
						{
							if (css_class_name_pattern.test(object[i].active_drop_down_list))
							{
								this.custom_config[i].active_drop_down_list = object[i].active_drop_down_list;
							}
						}
					}
					
					if (object[i].hasOwnProperty('active_list_item'))
					{
						if (typeof object[i].active_list_item === 'string')
						{
							if (css_class_name_pattern.test(object[i].active_list_item))
							{
								this.custom_config[i].active_list_item = object[i].active_list_item;
							}
						}
					}
					
					if (object[i].hasOwnProperty('json'))
					{
						if (object[i].json.hasOwnProperty('is_data_ready'))// && hasOwnProperty('data');
						{
							if (typeof object[i].json.is_data_ready === 'boolean')
							{
								if (object[i].json.is_data_ready)
								{
									this.data[i] = this.getOptionsFromJSON(i, object[i].json.data);
								}
								else
								{
									this.custom_config[i].is_data_ready = false;
									this.custom_config[i].data = object[i].json.data;
								}
							}
						}
					}
					else
					{
						var selector = $('select#'+i),
							options_selector = selector.children();
							//console.log(options_selector);

						if (selector.length)
						{
							selector.hide();
	
							this.data[i] = this.getOptionsFromSelect(i, options_selector);//selector.children()
							
							this.custom_config[i].is_select = true;
						}
					}
				}
			}
			
			var input_fields_length = this.input_fields.length;
			
			if (input_fields_length)
			{
				this.is_data_ready = true;
				
				var combo_box_input = [];

				for (let i = 0; i < input_fields_length; ++i)// rewrite with for (let i of this.input_fields)
				{
					combo_box_input.push('input#'+this.input_fields[i]);
				}

				$('body').on('focus', combo_box_input.join(','), function(event)
				{
					//console.log(event);
					combo_box.focused_input = $(this).attr('id');

					combo_box.removeDropDownList();
					
					if (combo_box.is_data_ready)
					{
						//combo_box.setDropDownList(); rework maybe is_data_ready part of config
					}
					
					if (combo_box.custom_config[combo_box.focused_input].is_select)
					{
						combo_box.is_data_ready = true;// true by default for select
						combo_box.input_characters = $('input#'+combo_box.focused_input).val().trim();
						combo_box.setDropDownList();
					}
				});
			}
		}

		$('body').on('click focus', 'ul[id^='+this.selector_scheme+'] > li:not(.header):not(.optgroup)', function()
		{
			var list_item_text = $(this).text(),
				list_item_data_value = $(this).data('value');

			$('input#'+combo_box.focused_input).val(list_item_text).attr({'value' : list_item_text, 'data-value' : list_item_data_value});
			$('input#'+combo_box.focused_input).data('value', list_item_data_value).trigger('change');

			combo_box.removeDropDownList();
		});
	},
	getOptionsFromJSON : function(selector_id, data)
	{
		var i,
			key_value_pair = {},
			is_value_numeric = this.config.is_value_numeric,
			counter = 0;

		if (this.custom_config[selector_id].hasOwnProperty('is_value_numeric'))
		{
			is_value_numeric = this.custom_config[selector_id].is_value_numeric;
		}

		for (i in data)
		{
			++counter;
			key_value_pair[counter] = {
				group : '',
				value : data[i].id,
				text : data[i].value
			};
			/*
			if (is_value_numeric)
			{
				if ($.isNumeric(i))
				{
					key_value_pair[i] = data[i];
				}
			}
			else
			{
				key_value_pair[i] = data[i];
			}*/
		}

		return key_value_pair;
	},
	getOptionsFromDatabase : function(object)
	{
		this.is_data_ready = false;

		var set_interval = setInterval(function()
		{
			if (object.is_data_ready)
			{
				clearInterval(set_interval);

				combo_box.data[combo_box.focused_input] = combo_box.getOptionsFromJSON(combo_box.focused_input, object.data);

				combo_box.is_data_ready = true;
			}
		}, 50);
	},
	getOptionsFromSelect : function(selector_id, options_selector)
	{
		var key_value_pair = {},
			is_value_numeric = this.config.is_value_numeric;

		if (this.custom_config[selector_id].hasOwnProperty('is_value_numeric'))
		{
			is_value_numeric = this.custom_config[selector_id].is_value_numeric;
		}
		
let counter = 0;

		options_selector.each(function()
		{
			if ($(this)[0].tagName.toLowerCase() === 'optgroup')
			{
				let optgroup = $(this).attr('label');
				
				$(this).children().each(function()
				{
					++counter;
					
					key_value_pair[counter] = {
							group : optgroup,
							value : $(this).val(),
							text : $(this).text()
						};
				});
			}
			else
			{
				++counter;
				
				key_value_pair[counter] = {
							group : '',
							value : $(this).val(),
							text : $(this).text()
						};
			}
			/*
			var value = $(this).val();

			if (is_value_numeric)
			{
				if ($.isNumeric(value))
				{
					key_value_pair[value] = $(this).text();
				}
			}
			else
			{
				key_value_pair[value] = $(this).text();
			}*/
		});
//console.log(key_value_pair);
		return key_value_pair;
	},
	setDropDownList : function()
	{
		console.log(combo_box.data[combo_box.focused_input]);
		return;
		if (this.custom_config[this.focused_input].minimum_input_length > combo_box.input_characters)
		{
			//console.log(this.custom_config[this.focused_input].minimum_input_length);
		}
		
		var set_interval = setInterval(function()
		{
			if (combo_box.is_data_ready)
			{
				clearInterval(set_interval);

				combo_box.removeDropDownList();

				let window_height = parseInt($(window).height(), 10),
					element_top = parseInt($(`input#${combo_box.focused_input}`).offset().top, 10) + 30;

				let ul_position = 'down';
				
				if (window_height - (element_top - window.scrollY) <= 290)
				{
					ul_position = 'up';
				}

				var i,
					object = combo_box.data[combo_box.focused_input],
					match_list_items = {},
					unmatch_list_items = {},
					pointer = 0,
					counter = 0,
					drop_down = $('<ul>').attr({'id' : combo_box.focused_input, 'class' : `combo-box ${ul_position}`}).hide(),
					escape_characters = ['?', '*', '+', '[', ']', '(', ')'],
					input_characters = (function()
					{
						var i,
							escape_string = '';
						
						for (i in combo_box.input_characters)
						{
							if ($.inArray(combo_box.input_characters[i], escape_characters) >= 0)
							{
								escape_string += '\\';
							}
							
							escape_string += combo_box.input_characters[i];
						}
						
						return escape_string;
					})(),
					pattern_input_characters = new RegExp(input_characters, 'ig');
					
				if (combo_box.custom_config[combo_box.focused_input].hasOwnProperty('active_drop_down_list'))
				{
					drop_down.addClass(combo_box.custom_config[combo_box.focused_input].active_drop_down_list);
				}
				
				$('input#'+combo_box.focused_input).after(drop_down);
//console.log(object);
				for (i in object)
				{
					let group = object[i].group,
						value = object[i].value,
						string = object[i].text;
					
					if (!match_list_items.hasOwnProperty(group))
					{
						match_list_items[group] = [];
					}
					
					if (!unmatch_list_items.hasOwnProperty(group))
					{
						unmatch_list_items[group] = [];
					}
					
					if (!group.length && !value.length)
					{
						++pointer;
						
						match_list_items[group].push(`<li data-value="${value}" class="highlight" id="pointer-${pointer}">${string}</li>`);
						
						continue;
					}

					if (pattern_input_characters.test(string) && input_characters.length)
					{
						++pointer;
						++counter;

						let search = string.match(pattern_input_characters),
							replace_range = [];
						
						for (let s of search)
						{
							let lower_s = s.toLocaleLowerCase(),
								index_from = replace_range.length ? replace_range[replace_range.length - 2] + lower_s.length : 0;

							replace_range.push(string.toLocaleLowerCase().indexOf(lower_s, index_from));
							replace_range.push(lower_s.length);
						}

						let highlight = '',
							close_tag = NaN;
						
						for (let r = 0; r < string.length; ++r)// [...string]
						{
							if (replace_range.length && r === replace_range[0])
							{
								highlight += `<b>${string[r]}`;
								
								close_tag = replace_range[0] + replace_range[1] - 1;

								replace_range.splice(0, 2);
							}
							else
							{
								highlight += string[r];
							}
							
							if (r === close_tag)
							{
								highlight += '</b>';
							}
						}

						match_list_items[group].push(`<li data-value="${value}" class="highlight" id="pointer-${pointer}">${highlight}</li>`);
					}
					else
					{
						unmatch_list_items[group].push(`<li data-value="${value}">${string}</li>`);
					}
				}

				if (counter !== 0 || true)// rework condition for empty matches
				{
					combo_box.drop_down.length = combo_box.custom_config[combo_box.focused_input].is_select ? Object.keys(object).length : counter;
					combo_box.drop_down.selector = drop_down;
					
					let found = combo_box.config.found_message.replace('%', counter),// message for select or from db
						list_found = `<li class="header">${found}</li>`,
						list_items = '';
						
					for (let i in match_list_items)
					{
						if (i.length && match_list_items[i].length)
						{
							list_items += `<li class="optgroup">${i}</li>`;
						}
						
						list_items += match_list_items[i].join('');
					}
						
					if (combo_box.custom_config[combo_box.focused_input].is_select)
					{
						for (let i in unmatch_list_items)
						{
							if (i.length && unmatch_list_items[i].length)
							{
								list_items += `<li class="optgroup">${i}</li>`;
							}
							
							for (let ii of unmatch_list_items[i])
							{
								++pointer;
								
								list_items += $(ii).attr('id', `pointer-${pointer}`)[0].outerHTML;
							}
						}
					}
					
					drop_down.html(list_found+list_items).show();
				}
				else
				{
					combo_box.drop_down.pointer = 0;
				}
			}
		}, 100);
	},
	stepThroughDropDownList : function()
	{
		//console.log(this.drop_down);
		if (this.drop_down.length)
		{
			var active_list_item = this.config.active_list_item;

			if (this.custom_config[this.focused_input].hasOwnProperty('active_list_item'))
			{
				active_list_item = this.custom_config[this.focused_input].active_list_item;
			}

			if (this.drop_down.length === 1)
			{
				this.drop_down.pointer = 1;
				this.drop_down.selector.find('#pointer-1').addClass(active_list_item);
			}
			else
			{
				this.drop_down.selector.children().removeClass(active_list_item);// optgroup rework

				var pointer_position;

				if (this.events.press_down_arrow)
				{
					if (this.drop_down.pointer === 0)
					{
						pointer_position = 1;
					}
					else if (this.drop_down.pointer === this.drop_down.length)
					{
						pointer_position = 1;
					}
					else
					{
						pointer_position = this.drop_down.pointer + 1;
					}
				}

				if (this.events.press_up_arrow)
				{
					if (this.drop_down.pointer === 0)
					{
						pointer_position = this.drop_down.length;
					}
					else if (this.drop_down.pointer === this.drop_down.length)
					{
						pointer_position = this.drop_down.length - 1;
					}
					else
					{
						pointer_position = (this.drop_down.pointer - 1 > 0) ? this.drop_down.pointer - 1 : this.drop_down.length;
					}
				}

				this.drop_down.pointer = pointer_position;
				
				let parent_element_height = this.drop_down.selector[0].clientHeight,
					element = this.drop_down.selector.find('#pointer-'+pointer_position);
				
				element.addClass(active_list_item);
				
				let offset_top = element[0].offsetTop;

				if (offset_top > parent_element_height)
				{
					this.drop_down.selector[0].scrollTop = offset_top + element[0].offsetHeight - parent_element_height;
				}
				else
				{
					this.drop_down.selector[0].scrollTop = 0;
				}
			}
		}
	},
	removeDropDownList : function()
	{
		this.drop_down.pointer = 0;

		var i,
			input_fields_length = this.input_fields.length,
			combo_box_input = [];

		for (i = 0; i < input_fields_length; ++i)
		{
			combo_box_input.push('input#'+this.input_fields[i]+' + ul');
		}

		$(combo_box_input.join(',')).remove();
	},
	keyup : function()
	{
		$(document).on('keyup', function(event)
		{
			var focused_form_element_id = $('input:focus').attr('id');
			//combo_box.test.push([event.which, event.originalEvent.key]);
			
			if (typeof focused_form_element_id === 'undefined' || $.inArray(focused_form_element_id, combo_box.input_fields) < 0)// includes array
			{
				return;
			}
			/*
			let test = '\\';
			let punctuation = [...`.,:;'"!?<>`];
			let math_symbols = [...'-+/*'];
			let letters = ['A', 'a', 'B', 'b', 'C', 'c'];
			let digits = ['0', '1', '2'];
			console.log(punctuation, math_symbols, letters, digits);
			*/
			// rewrite with event.originalEvent.key
			var character_keys = [
				8,// backspace
				16,// shift
				17,// ctrl
				18,// alt
				20,// caps lock
				32,// space
				46,// delete
				48,// 0
				49,// 1
				50,// 2
				51,// 3
				52,// 4
				53,// 5
				54,// 6
				55,// 7
				56,// 8
				57,// 9
				65,// a
				66,// b
				67,// c
				68,// d
				69,// e
				70,// f
				71,// g
				72,// h
				73,// i
				74,// j
				75,// k
				76,// l
				77,// m
				78,// n
				79,// o
				80,// p
				81,// q
				82,// r
				83,// s
				84,// t
				85,// u
				86,// v
				87,// w
				88,// x
				89,// y
				90,// z
				96,// 0 numpad
				97,// 1 numpad
				98,// 2 numpad
				99,// 3 numpad
				100,// 4 numpad
				101,// 5 numpad
				102,// 6 numpad
				103,// 7 numpad
				104,// 8 numpad
				105// 9 numpad
			],
			mathematics_keys = [
				61,// equal
				106,// multiply numpad
				107,// add numpad
				109,// subtract numpad
				110,// decimal point numpad
				111,// divide numpad
				173,// minus
				219,// open bracket
				221// close braket
			],
			punctuation_keys = [
				188,// comma
				189,// dash
				190,// period
				191,// forward slash
				192,// grave accent
				220,// back slash
				222// single quote
			];
			
			var allowed_keys = character_keys,
				are_mathematics_symbols_allowed = combo_box.config.are_mathematics_symbols_allowed,
				are_punctuation_symbols_allowed = combo_box.config.are_punctuation_symbols_allowed;
			
			if (combo_box.custom_config[combo_box.focused_input].hasOwnProperty('are_mathematics_symbols_allowed'))
			{
				are_mathematics_symbols_allowed = combo_box.custom_config[combo_box.focused_input].are_mathematics_symbols_allowed;
			}
			
			if (combo_box.custom_config[combo_box.focused_input].hasOwnProperty('are_punctuation_symbols_allowed'))
			{
				are_punctuation_symbols_allowed = combo_box.custom_config[combo_box.focused_input].are_punctuation_symbols_allowed;
			}
			
			if (are_mathematics_symbols_allowed)
			{
				allowed_keys = allowed_keys.concat(mathematics_keys);
			}
			
			if (are_punctuation_symbols_allowed)
			{
				allowed_keys = allowed_keys.concat(punctuation_keys);
			}

			if ($.inArray(event.which, allowed_keys) >= 0)
			{
				var minimum_input_length = combo_box.config.minimum_input_length,
					input_length = $('input#'+combo_box.focused_input).val().trim().length;

				if (combo_box.custom_config[combo_box.focused_input].hasOwnProperty('minimum_input_length'))
				{
					minimum_input_length = combo_box.custom_config[combo_box.focused_input].minimum_input_length;
				}

				if (input_length >= minimum_input_length)
				{
					combo_box.input_characters = $('input#'+combo_box.focused_input).val().trim();

					if (combo_box.custom_config[combo_box.focused_input].hasOwnProperty('is_data_ready'))
					{
						if (!combo_box.custom_config[combo_box.focused_input].is_data_ready)
						{
							combo_box.getOptionsFromDatabase(combo_box.custom_config[combo_box.focused_input].data());
						}
					}

					combo_box.setDropDownList();
				}
				else
				{
					combo_box.removeDropDownList();
				}
			}
		});
	}(),
	keydown : function()
	{
		$(document).on('keydown', function(event)
		{
			if (event.which === 13)
			{
				if (combo_box.drop_down.pointer !== 0)
				{
					var list_item = combo_box.drop_down.selector.find('#pointer-'+combo_box.drop_down.pointer),
						list_item_text = list_item.text(),
						list_item_data_value = list_item.data('value');

					$('input#'+combo_box.focused_input).val(list_item_text).attr({'value' : list_item_text, 'data-value' : list_item_data_value});
					$('input#'+combo_box.focused_input).data('value', list_item_data_value).trigger('change');

					combo_box.removeDropDownList();
				}

				return;
			}

			if (event.which === 38)
			{
				combo_box.events.press_up_arrow = true;
				combo_box.events.press_down_arrow = false;
				combo_box.stepThroughDropDownList();

				return;
			}

			if (event.which === 40)
			{
				combo_box.events.press_down_arrow = true;
				combo_box.events.press_up_arrow = false;
				combo_box.stepThroughDropDownList();

				return;
			}

			if (event.which === 27)
			{
				combo_box.removeDropDownList();
			}
		});
	}()
};

//var json_data = '{"1":"Sofia","2":"Varna","3":"Plovdiv","4":"Sofia Center","5":"Burgas"}';
var json_data = '[{"id":1,"value":"testova"},{"id":2,"value":"test"},{"id":3,"value":"асдасдасд"},{"id":4,"value":"sofia"}]';
var combo_box_init = {
	'js-combo-box-cars' : {
		value_is_numeric : true
	},
	'js-combo-box-languages' : {
		minimum_input_length : 1,
		//active_list_item : 'custom'
	},
	'js-combo-box-cities' : {
		minimum_input_length : 3,
		json : {
			is_data_ready : true,
			data : JSON.parse(json_data)
		}
	},
	'js-combo-box-names' : {
		json : {
			is_data_ready : false,
			data : function()
			{
				var object = {
					is_data_ready : false
				};

				setTimeout(function()
				{
					object.data = {1 : 'jameson', 2 : 'jack daniels', 3 : 'tomas anderson'};
					object.is_data_ready = true;
				}, 1000);

				return object;
			}
		}
	}
};
$(combo_box.construct(combo_box_init));
</script>
</body>
</html>